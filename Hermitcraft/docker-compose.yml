services:
  mc:
    image: itzg/minecraft-server:java21
    container_name: hermitcraft-server
    tty: true
    stdin_open: true
    restart: unless-stopped

    ports:
      - "25565:25565"
      - "25575:25575"      # RCON
      - "24454:24454/udp"  # Simple Voice Chat

    volumes:
      - ./data:/data       # Persist world/modpack data next to this compose file

    environment:
      # Core server and modpack
      EULA: "TRUE"
      TYPE: "MODRINTH"          # Lets the image install the Modrinth pack + Fabric loader
      VERSION: "1.21.10"        # Minecraft version; keep in sync with the modpack release
      MODRINTH_MODPACK: "hermitcraft"
      MODRINTH_VERSION: "2.0.1" # Modpack version number/ID from Modrinth
      MODRINTH_DOWNLOAD_DEPENDENCIES: "required"
      MEMORY: "7G"

      # World and gameplay
      SERVER_NAME: "Not-Hermitcraft 11 Server"
      MOTD: "Welcome to Not-Hermitcraft Season 11!"
      DIFFICULTY: "hard"
      MODE: "survival"
      LEVEL: "world"
      SEED: "-2654832327628292536"  # Set to lock the seed; leave blank for random
      LEVEL_TYPE: "minecraft:normal"
      GENERATE_STRUCTURES: "true"

      # Players and security
      OPS: "Soulforge"
      WHITELIST: "Soulforge"
      ENABLE_WHITELIST: "true"
      ENFORCE_WHITELIST: "true"
      ONLINE_MODE: "true"
      ENABLE_RCON: "true"
      RCON_PASSWORD: "change-me"  # Replace before going public

      # Game rules / server properties
      ENABLE_COMMAND_BLOCK: "true"
      SPAWN_PROTECTION: "0"
      ENABLE_QUERY: "true"
      VIEW_DISTANCE: "12"
      SIMULATION_DISTANCE: "10"
      MAX_PLAYERS: "20"
      MAX_TICK_TIME: "60000"
      OVERRIDE_SERVER_PROPERTIES: "true"

      # JVM tuning (Aikar flags for ~7G heap)
      JVM_OPTS: >-
        -XX:+UseG1GC
        -XX:+ParallelRefProcEnabled
        -XX:MaxGCPauseMillis=200
        -XX:+UnlockExperimentalVMOptions
        -XX:+DisableExplicitGC
        -XX:G1NewSizePercent=30
        -XX:G1MaxNewSizePercent=40
        -XX:G1HeapRegionSize=8M
        -XX:G1ReservePercent=20
        -XX:G1HeapWastePercent=5
        -XX:G1MixedGCCountTarget=4
        -XX:InitiatingHeapOccupancyPercent=15
        -XX:G1MixedGCLiveThresholdPercent=90
        -XX:G1RSetUpdatingPauseTimePercent=5
        -XX:SurvivorRatio=32
        -XX:+PerfDisableSharedMem
        -XX:MaxTenuringThreshold=1

      # Logging
      ENABLE_ROLLING_LOGS: "true"
      LOG_TIMESTAMP: "true"

      # Optional: auto-install extra server-only mods/datapacks from Modrinth
      # MODRINTH_PROJECTS: |
      #   spark:1.10.152-fabric

    healthcheck:
      test: ["CMD", "mc-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5m
